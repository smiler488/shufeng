
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像量化分析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        .result-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .annotation-overlay {
            position: relative;
            display: inline-block;
        }
        .annotation-overlay img {
            max-width: 100%;
            height: auto;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-microscope text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">图像量化分析工具</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧控制面板 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 图像上传 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-upload text-blue-600 mr-2"></i>
                        图像上传
                    </h2>
                    <div id="uploadArea" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">拖拽图像到此处或点击选择</p>
                        <p class="text-sm text-gray-500">支持 JPG, PNG, GIF 格式</p>
                        <input type="file" id="fileInput" class="hidden" accept="image/*">
                    </div>
                    <div id="imagePreview" class="mt-4 hidden">
                        <img id="previewImg" class="w-full rounded-lg" alt="预览图像">
                        <button id="removeImage" class="mt-2 text-red-600 hover:text-red-700 text-sm">
                            <i class="fas fa-trash mr-1"></i>移除图像
                        </button>
                    </div>
                </div>

                <!-- 分析参数 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-sliders-h text-green-600 mr-2"></i>
                        分析参数
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- 样本类型 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">样本类型</label>
                            <select id="sampleType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="leaves">叶片</option>
                                <option value="seeds-grains">种子/谷物</option>
                            </select>
                        </div>

                        <!-- 预期数量 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                预期数量: <span id="expectedCountValue">5</span>
                            </label>
                            <input type="range" id="expectedCount" min="1" max="50" value="5" class="w-full">
                        </div>

                        <!-- 参考对象模式 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">参考对象模式</label>
                            <select id="refMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="auto">自动检测</option>
                                <option value="coin">硬币</option>
                                <option value="square">方形卡片</option>
                            </select>
                        </div>

                        <!-- 参考对象尺寸 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                参考对象尺寸 (mm): <span id="refSizeValue">25.0</span>
                            </label>
                            <input type="range" id="refSize" min="1" max="100" value="25" step="0.1" class="w-full">
                        </div>

                        <!-- 面积范围 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                最小面积 (px²): <span id="minAreaValue">500</span>
                            </label>
                            <input type="range" id="minArea" min="10" max="5000" value="500" step="10" class="w-full">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                最大面积 (px²): <span id="maxAreaValue">50000</span>
                            </label>
                            <input type="range" id="maxArea" min="1000" max="200000" value="50000" step="1000" class="w-full">
                        </div>

                        <!-- HSV范围（仅叶片） -->
                        <div id="hsvControls">
                            <label class="block text-sm font-medium text-gray-700 mb-2">HSV色调范围</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-600">下限: <span id="hsvLowValue">35</span></label>
                                    <input type="range" id="hsvLow" min="0" max="179" value="35" class="w-full">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">上限: <span id="hsvHighValue">85</span></label>
                                    <input type="range" id="hsvHigh" min="0" max="179" value="85" class="w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-play-circle text-orange-600 mr-2"></i>
                        操作控制
                    </h2>
                    
                    <div class="space-y-3">
                        <button id="analyzeBtn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center font-medium disabled:opacity-50">
                            <i class="fas fa-search mr-2"></i>
                            开始分析
                        </button>
                        
                        <button id="resetBtn" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center font-medium">
                            <i class="fas fa-redo mr-2"></i>
                            重置
                        </button>
                    </div>

                    <!-- 交互校正模式 -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">交互校正模式</label>
                        <select id="correctionMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="none">无</option>
                            <option value="set-ref">设置参考对象</option>
                            <option value="toggle-sample">切换样本选择</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">点击标注图像进行交互校正</p>
                    </div>
                </div>
            </div>

            <!-- 右侧结果展示 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 标注图像 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-image text-purple-600 mr-2"></i>
                        标注图像
                    </h2>
                    
                    <div id="imageContainer" class="annotation-overlay">
                        <div id="placeholderImage" class="bg-gray-100 rounded-lg p-12 text-center">
                            <i class="fas fa-image text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">上传图像后显示分析结果</p>
                        </div>
                        <img id="annotatedImage" class="hidden rounded-lg cursor-crosshair" alt="标注图像">
                    </div>

                    <!-- 加载状态 -->
                    <div id="loadingState" class="hidden text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">正在分析图像...</p>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-table text-indigo-600 mr-2"></i>
                        量化数据
                    </h2>
                    
                    <div id="dataTableContainer" class="result-table">
                        <div id="placeholderTable" class="text-center py-8 text-gray-500">
                            <i class="fas fa-table text-4xl text-gray-300 mb-3"></i>
                            <p>分析完成后显示数据表格</p>
                        </div>
                        <div id="dataTable" class="hidden overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">标签</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">长度(mm)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">宽度(mm)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">面积(mm²)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">周长(mm)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">长宽比</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">圆形度</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">角度(°)</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 导出按钮 -->
                    <div id="exportButtons" class="mt-4 flex space-x-3 hidden">
                        <button id="exportCSV" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-file-csv mr-2"></i>
                            导出CSV
                        </button>
                        <button id="exportJSON" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-file-code mr-2"></i>
                            导出JSON
                        </button>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div id="statisticsPanel" class="bg-white rounded-lg shadow p-6 hidden">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-teal-600 mr-2"></i>
                        统计信息
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                            <div class="text-sm text-blue-600">检测数量</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600" id="avgLength">0</div>
                            <div class="text-sm text-green-600">平均长度(mm)</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600" id="avgArea">0</div>
                            <div class="text-sm text-purple-600">平均面积(mm²)</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-orange-600" id="pixelRatio">0</div>
                            <div class="text-sm text-orange-600">像素/毫米</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局状态
        let currentImage = null;
        let analysisResults = null;
        let analysisState = null;

        // DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImage = document.getElementById('removeImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loadingState = document.getElementById('loadingState');
        const placeholderImage = document.getElementById('placeholderImage');
        const annotatedImage = document.getElementById('annotatedImage');
        const placeholderTable = document.getElementById('placeholderTable');
        const dataTable = document.getElementById('dataTable');
        const exportButtons = document.getElementById('exportButtons');
        const statisticsPanel = document.getElementById('statisticsPanel');

        // 滑块值显示
        const expectedCount = document.getElementById('expectedCount');
        const expectedCountValue = document.getElementById('expectedCountValue');
        const refSize = document.getElementById('refSize');
        const refSizeValue = document.getElementById('refSizeValue');
        const minArea = document.getElementById('minArea');
        const minAreaValue = document.getElementById('minAreaValue');
        const maxArea = document.getElementById('maxArea');
        const maxAreaValue = document.getElementById('maxAreaValue');
        const hsvLow = document.getElementById('hsvLow');
        const hsvLowValue = document.getElementById('hsvLowValue');
        const hsvHigh = document.getElementById('hsvHigh');
        const hsvHighValue = document.getElementById('hsvHighValue');

        // 样本类型切换
        const sampleType = document.getElementById('sampleType');
        const hsvControls = document.getElementById('hsvControls');

        // 交互校正
        const correctionMode = document.getElementById('correctionMode');

        // 更新滑块显示值
        expectedCount.addEventListener('input', () => {
            expectedCountValue.textContent = expectedCount.value;
        });

        refSize.addEventListener('input', () => {
            refSizeValue.textContent = parseFloat(refSize.value).toFixed(1);
        });

        minArea.addEventListener('input', () => {
            minAreaValue.textContent = minArea.value;
        });

        maxArea.addEventListener('input', () => {
            maxAreaValue.textContent = maxArea.value;
        });

        hsvLow.addEventListener('input', () => {
            hsvLowValue.textContent = hsvLow.value;
        });

        hsvHigh.addEventListener('input', () => {
            hsvHighValue.textContent = hsvHigh.value;
        });

        // 样本类型切换
        sampleType.addEventListener('change', () => {
            if (sampleType.value === 'leaves') {
                hsvControls.style.display = 'block';
            } else {
                hsvControls.style.display = 'none';
            }
        });

        // 文件上传处理
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                alert('请选择图像文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                previewImg.src = currentImage;
                uploadArea.classList.add('hidden');
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        removeImage.addEventListener('click', () => {
            currentImage = null;
            analysisResults = null;
            analysisState = null;
            uploadArea.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            resetResults();
        });

        // 分析按钮
        analyzeBtn.addEventListener('click', performAnalysis);

        async function performAnalysis() {
            if (!currentImage) {
                alert('请先上传图像');
                return;
            }

            // 显示加载状态
            loadingState.classList.remove('hidden');
            placeholderImage.classList.add('hidden');
            annotatedImage.classList.add('hidden');
            analyzeBtn.disabled = true;

            try {
                // 模拟分析过程
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 生成模拟结果
                const mockResults = generateMockResults();
                displayResults(mockResults);
                
            } catch (error) {
                console.error('分析失败:', error);
                alert('分析失败，请重试');
            } finally {
                loadingState.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        function generateMockResults() {
            const count = parseInt(expectedCount.value);
            const results = [];
            
            for (let i = 1; i <= count; i++) {
                results.push({
                    label: `s${i}`,
                    length_mm: (Math.random() * 50 + 20).toFixed(2),
                    width_mm: (Math.random() * 30 + 10).toFixed(2),
                    area_mm2: (Math.random() * 1000 + 200).toFixed(2),
                    perimeter_mm: (Math.random() * 150 + 50).toFixed(2),
                    aspect_ratio: (Math.random() * 2 + 1).toFixed(2),
                    circularity: (Math.random() * 0.5 + 0.5).toFixed(3),
                    angle_deg: (Math.random() * 180).toFixed(1),
                    meanR: Math.floor(Math.random() * 100 + 100),
                    meanG: Math.floor(Math.random() * 100 + 150),
                    meanB: Math.floor(Math.random() * 50 + 50),
                    hue: Math.floor(Math.random() * 60 + 30),
                    saturation: Math.floor(Math.random() * 100 + 100),
                    value: Math.floor(Math.random() * 100 + 150),
                    greenIndex: (Math.random() * 0.5).toFixed(3),
                    brownIndex: (Math.random() * 0.3).toFixed(3)
                });
            }

            return {
                components: results,
                pixelRatio: 4.0,
                annotatedImage: currentImage // 实际应用中应该是处理后的图像
            };
        }

        function displayResults(results) {
            analysisResults = results;
            
            // 显示标注图像
            annotatedImage.src = results.annotatedImage;
            placeholderImage.classList.add('hidden');
            annotatedImage.classList.remove('hidden');

            // 显示数据表格
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            results.components.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${item.label}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.length_mm}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.width_mm}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.area_mm2}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.perimeter_mm}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.aspect_ratio}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.circularity}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${item.angle_deg}</td>
                `;
            });

            placeholderTable.classList.add('hidden');
            dataTable.classList.remove('hidden');
            exportButtons.classList.remove('hidden');
            statisticsPanel.classList.remove('hidden');

            // 更新统计信息
            updateStatistics(results);
        }

        function updateStatistics(results) {
            const count = results.components.length;
            const avgLength = (results.components.reduce((sum, item) => sum + parseFloat(item.length_mm), 0) / count).toFixed(2);
            const avgArea = (results.components.reduce((sum, item) => sum + parseFloat(item.area_mm2), 0) / count).toFixed(2);

            document.getElementById('totalCount').textContent = count;
            document.getElementById('avgLength').textContent = avgLength;
            document.getElementById('avgArea').textContent = avgArea;
            document.getElementById('pixelRatio').textContent = results.pixelRatio.toFixed(2);
        }

        // 重置按钮
        resetBtn.addEventListener('click', resetResults);

        function resetResults() {
            analysisResults = null;
            analysisState = null;
            
            placeholderImage.classList.remove('hidden');
            annotatedImage.classList.add('hidden');
            placeholderTable.classList.remove('hidden');
            dataTable.classList.add('hidden');
            exportButtons.classList.add('hidden');
            statisticsPanel.classList.add('hidden');
            
            document.getElementById('dataTableBody').innerHTML = '';
        }

        // 导出功能
        document.getElementById('exportCSV').addEventListener('click', () => {
            if (!analysisResults) return;
            
            let csv = 'Label,Length(mm),Width(mm),Area(mm²),Perimeter(mm),Aspect Ratio,Circularity,Angle(°)\n';
            analysisResults.components.forEach(item => {
                csv += `${item.label},${item.length_mm},${item.width_mm},${item.area_mm2},${item.perimeter_mm},${item.aspect_ratio},${item.circularity},${item.angle_deg}\n`;
            });
            
            downloadFile(csv, 'analysis_results.csv', 'text/csv');
        });

        document.getElementById('exportJSON').addEventListener('click', () => {
            if (!analysisResults) return;
            
            const json = JSON.stringify(analysisResults.components, null, 2);
            downloadFile(json, 'analysis_results.json', 'application/json');
        });

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 图像点击交互
        annotatedImage.addEventListener('click', (e) => {
            if (!analysisResults || correctionMode.value === 'none') return;
            
            const rect = annotatedImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            console.log(`点击位置: (${x.toFixed(0)}, ${y.toFixed(0)}), 模式: ${correctionMode.value}`);
            
            // 这里可以实现实际的交互校正逻辑
            if (correctionMode.value === 'set-ref') {
                alert('设置参考对象功能需要在实际应用中实现');
            } else if (correctionMode.value === 'toggle-sample') {
                alert('切换样本选择功能需要在实际应用中实现');
            }
        });

        // 初始化
        sampleType.dispatchEvent(new Event('change'));
    </script>
</body>
</html>
    